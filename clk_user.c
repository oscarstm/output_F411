/*
 * clk_user.c
 *
 *  Created on: Aug 3, 2025
 *      Author: oscar
 */

#include "clk_user.h"

void clk_user_init(void) {
	FLASH->ACR |= FLASH_ACR_ICEN;
	FLASH->ACR |= FLASH_ACR_PRFTEN;
	FLASH->ACR |= FLASH_ACR_DCEN;
	FLASH->ACR |= FLASH_ACR_LATENCY_3WS;

	RCC->CR |= RCC_CR_HSEON;

	while ((RCC->CR & RCC_CR_HSERDY) == RCC_CR_HSERDY) {
		//
	}

	RCC->PLLCFGR |= RCC_PLLCFGR_PLLSRC_HSE;

	// 13
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLM_0;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLM_1;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLM_2;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLM_3;

	// 100
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLN_0;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLN_1;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLN_2;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLN_3;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLN_4;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLN_5;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLN_6;

	// 2
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLP_0;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLP_1;

	// 4
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLQ_0;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLQ_1;
	RCC->PLLCFGR |= RCC_PLLCFGR_PLLQ_2;
	RCC->PLLCFGR &= ~RCC_PLLCFGR_PLLQ_3;

	RCC->CR |= RCC_CR_PLLON;

	while ((RCC->CR & RCC_CR_PLLRDY) == RCC_CR_PLLRDY) {
		//
	}
	// AHB
	RCC->CFGR |= RCC_CFGR_HPRE_DIV1;

	// APB1
	RCC->CFGR &= ~RCC_CFGR_PPRE1_0;
	RCC->CFGR &= ~RCC_CFGR_PPRE1_1;
	RCC->CFGR |= RCC_CFGR_PPRE1_2;

	// APB2
	RCC->CFGR |= RCC_CFGR_PPRE2_DIV1;

	// PLL
	RCC->CFGR &= ~RCC_CFGR_SW_0;
	RCC->CFGR |= RCC_CFGR_SW_1;
}
